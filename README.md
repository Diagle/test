# 第三章 数据链路层

[toc]

基本概念

结点：主机、路由器

链路：网络中两个结点之间的物理通道，链路的传输介质主要有双绞线、光纤和微波。分为有线链路、无线链路

数据链路：网络中两个结点之间的逻辑通道，把实现控制数据传输协议的硬件和软件加到链路上就构成数据链路

帧：链路层的协议数据单元，封装网络层数据报

数据链路层负责通过一条链路从一个结点但向另一个物理链路直接相连的相邻结点传送数据报

## 功能

功能概述：数据链路层在物理层提供服务的基础上向网络层提供服务，其最基本的服务是将源自网络层来的数据可靠地传输到相邻结点的目标网络层。其主要作用是加强物理传输层传输原始比特流的功能，将物理层提供的可能出错的物理连接改造称为逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路

- 为网络层提供服务。无确认无连接服务，有确认无连接服务，有确认有连接服务
- 链路管理，即连接的建立、维持、释放(用于面向连接的服务)
- 组帧
- 流量控制
- 差错控制(帧错/位错)

### 封装成帧和透明传输

封装成帧就是在一段数据的前后部分添加首部和尾部，这样就构成了一个帧。接收端在收到物理层上交的比特流后，九年根据首部和尾部的标记，从收到的比特流中识别帧的开始和结束

首部和尾部包含许多的控制信息，一个重要作用：帧定界(确定帧的界限)

帧同步：接收方应当能从接收到的二进制比特流中区分出帧的起始和终止

<img src="C:\Users\18992\AppData\Roaming\Typora\typora-user-images\image-20230702164325905.png" alt="image-20230702164325905" style="zoom:50%;" />

透明传输：不管所传数据是什么样的比特组合，都应当能够在链路上传送

组帧的四种方法：

- 字符计数法：帧首部使用一个计数字段(第一个字节，八位)来标明帧内字符数
- 字符(节)填充法：加入转义字符
- 零比特填充法：在发送端，扫描整个信息字段，只要连续5个1，就立即填入1个0；在接收端收到一个帧时，先找到标志字段确定边界，再用硬件对比特流进行扫描。发现连续5个1时，就把后面的0删除
- 违规编码法：可以用“高-高”，“低-低”来定界帧的起始和终止

由于字节技术法中count字段的脆弱性即字符填充实现上的复杂性二号不兼容性，目前较普遍使用的帧同步法时比特填充和违规编码法

### 差错控制

传输中的差错都是由于噪声引起的

全局性：由于线路本身电气特性所产生的随机噪声(热噪声)，是信道固有的，随机存在的

解决办法：提高信噪比来减少或避免干扰

局部性：外界特点的短暂原因所造成的冲击噪声，是产生差错的主要原因

解决办法：通常利用编码技术来解决

#### 位错

比特位出错

##### 检错编码

###### 奇偶检验码

n-1位信息元1位校验元

- 奇校验码
- 偶校验码

只能检查出奇数个比特错误，检错能力为50%

###### 循环冗余码CRC

1. 准备待传有效数据
2. 每个组都加上冗余码构成帧再发送
3. 接收方检验，余数为0则认为正确接收

##### 纠错编码：海明码

海明距离：

​	两个合法编码(码字)的对应比特取值不同的比特数称为这两个码字的海明距离(码距)，一个有效编码集中，任意两个合法编码(码字)的海明距离的最小值称为该编码集的海明距离

步骤：

1. 确定校验码位数r：数据/信息有m位，冗余位/校验码有r位；校验码一共有2^r^种取值；海明不等式2^r^≥m+r+1
2. 确定校验码和数据的位置：校验码放在序号为2^n^的位置，数据按位序填上
3. 求出校验码的值
4. 检错并纠错

#### 帧错

- 丢失
- 重复
- 失序

### 流量控制与可靠传输

#### 流量控制

较高的发送速度和较低的接受能力的不匹配，会造成传输出错，因此流量控制也是数据链路层的一项重要工作

数据链路层的流量控制是点对点的，而数据传输层的流量控制是端对端的

数据链路层流量控制手段：接收方收不下就不回复确认

传输层流量控制手段：接收端给发送端一个窗口公告

#### 流量控制的方法

##### 停止-等待协议

每发送一个帧就停止发送，等待对方的确认，再收到确认后再发送下一个帧

发送窗口大小=1，接收窗口大小=1

丢包：物理线路故障、设备故障、病毒攻击、路由信息错误等原因，会导致数据包的丢失

###### 无差错情况

###### 有差错情况

- 数据帧丢失或检测到帧出错：超市计时器——每次发送一个帧就启动一个计时器，少吃计时器设置的重传时间应当比帧传输的平均时延RTT更长一些
  - 发送完一个帧之后，必须保留它的副本
  - 数据帧和确认帧必须编号
- ACK丢失：同上，丢弃重复
- ACK迟到：丢弃

###### 性能分析

简单，信道利用率太低

信道利用率：发送方再一个发送周期内，有效地发送数据所需要的时间占整个发送周期的比率，信道利用率=(L/C)/T

L：T内发送L比特数据；C：发送方数据传输率；T：发送周期，从开始发送数据，到收到第一个确认帧为止

信道吞吐率：信道利用率*发送方的发送速率

##### 滑动窗口协议

###### 后退N帧协议(GBN)

发送窗口大小＞1，接收窗口大小=1

发送窗口：发送方维持一组连续的允许发送的帧的序号。发完被确认的、已经发生但等待确认的、还能发送的、还不能发的

接收窗口：接收方维持一组连续的允许接收帧的序号

GBN发送方：

- 上层的调用
- 收到了一个ACK：GBN协议中，对n号帧的确认采用**累计确认**的方式，标明接收方已经收到n号帧和它之前的全部帧
- 超时事件：出现超时，发送方重传所有已发送但未被确认的帧

GBN接收方：

- 如果正确收到n号帧，并且按序，那么接收方为n帧发送一个ACK，并将该帧中的数据部分交付给上层 
- **其余情况都丢弃帧**，并为**最近接收的帧重新发送ACK**。接收方无需缓存任何失序帧，只需要维护一个信息：expectedseqnum(下一个按序接收的顺序号)

滑动窗口长度

- 若采用n个比特对帧编号，那么发送串口的尺寸W~T~应满足：**1≤W~T~≤2^n^-1**，否则会因尺寸过大，使得接收方无法区别新帧和旧帧

性能分析：因连续发送数据帧而提高了信道利用率；在重传时必须把原来已经正确传送的数据帧重传，是传送效率降低

###### 选择重传协议(SR)

发送窗口大小＞1，接收窗口大小＞1

SR发送方：

- 上层的调用
- 收到了一个ACK：如果收到ACK，假如该帧序号在窗口内，则SR发送方将那个被确认的帧标记为已接收。如果该帧序号是窗口的下届(最左边的的第一个窗口对应的序号)，则窗口向前移动到具有最小序号的未确认帧处。如果窗口移动了并且有序号在窗口内的未发生帧，则发送这些帧
- 超时事件：每个帧都有自己的定时器，一个超时事件发生后只重传一个帧

SR接收方：来者不拒

- SR接收方将确认一个正确接收的帧而不管其释放按序。失序1帧将被缓存，并返回给发送方一个该帧的确认帧，直到所有帧(即序号更小的帧)皆被收到为止，这时才可以将一批帧按顺序交付给上层，然后向前移动滑动窗口
- 如果收到了窗口序号外(小于窗口下界)的帧，就返回一个ACK
- 其他情况，就忽略该帧

滑动窗口的长度：

- 发送窗口u自豪等于接收窗口
- W~Tmax~=W~Rmax~=2^n-1^

### 介质访问控制

采取一定的措施，使得两对结点之间的通信不会发生互相干扰的情况

#### 静态划分信道——信道划分介质访问控制（MAC）

将使用介质的每个设备与来自同一信道上的其他设备的通信隔离开，把时域和频域合理地分配给网络上的设备

多路复用技术：把多个信号组合在一条物理信道上进行传输，使得多个计算机或终端设备共享信道资源，提高信道利用率

把一条广播信道，逻辑上分成几条用于两个结点之间通信的互补干扰的子信道，实际就是把广播信道分为点对点信道

网络负载重：共享信道效率高，且公平

网络负载轻：共享信道效率低

##### 频分多路复用FDM

用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。频分复用的所有用户在同样的事件占用不同的带宽(频率带宽)资源

- 充分利用介质带宽，系统效率较高；

- 由于技术比较成熟，实现也比较容易

##### 时分多路复用TDM

将事件划分为一段段等长的时分复用帧(TDM帧)。每一时分复用技术的用户在每一个TDM帧中占用固定序号的时隙，所有用户轮流占用信道

- TDM帧是在物理层传送的比特流所划分的帧，标志一个周期
- 改进的时分复用——统计时分复用STDM
  - 每一个STDM帧中的时隙数小于连接在集中器上的用户数。个用户有了数据就随时发往集中器的输入缓存，然后集中器按顺序依次扫描输入缓存，把缓存中的输入数据放入STDM中，一个STDM帧满了就发出。STDM帧不是固定分配时隙，而是按需动态分配时隙

##### 波分多路复用WDM

光的频分多路复用，在一根光纤中传输多种不同的波长(频率)的光信号，由于波长(频率)不同，所以各路光信号互补干扰，最后再用波长分解复用器将各路波长分解出来

##### 码分多路复用CDM

码分多址(CDMA)时码分复用的一种方式。1个比特分为多个码片/芯片(chip)，每一个站点被指定一个唯一的m位的芯片序列，发生1时发送芯片序列(通常把0写成-1)；发送1时站点发送芯片序列，发送0时发送芯片序列反码

1. 多个站点同时发送数据的时候，要求各个站点芯片序列相互正交，规格化内积为0
2. 两个向量道路公共信道上，线性相加
3. 数据分离：合并的数据和源站规格化内积

#### 动态划分信道

动态媒体介入控制/多点接入

特点：信道并非在用户通信时固定分配给用户

##### 轮询访问(MAC)介质访问控制 令牌传递协议

既要不产生冲突，又要发送时占全部带宽

- 轮询协议：主结点轮流“邀请”从属结点发送数据
  - 轮询开销
  - 等待延迟
  - 单点故障
- 令牌传递协议
  - 令牌：一个特殊格式的MAC控制帧，不包含任何信息。控制信道的适用，确保同一时刻只有一个结点独占信道
  - 每个结点都可以在一定的时间内(令牌持有时间)获得发送数据的权利，并不是无限制地持有令牌
    - 令牌开销
    - 等待延迟
    - 单点故障
  - 应用于令牌环网：物理星型拓扑，逻辑环形拓扑
  - 采用令牌传送方式的网络常用于负载较重、通信量较大的网络中

##### 随机访问(MAC)介质访问控制：所有用户可随机发送信息。发送消息时占全部带宽

网络负载重：产生冲突开销

网络负载轻：共享信道效率高，单个结点可利用信道全部带宽

###### ALOHA协议

- 纯ALOHA协议
  - 不监听信道，不按时间槽发送，随机发送
  - 如果发生冲突，接收方就会检测出差错，然后不予确认，发送方在一定时间内收不到就判断发生冲突
  - 超时后等一随机时间再重传
- 时隙ALOHA协议
  - 把时间分成若干个相同的时间片，所有用户在时间片开始时刻同步接入网络信道，若发生冲突，则必须等到下一个时间片开始时刻再发送

###### CSMA协议(载波监听多路访问协议)

CS：载波侦听/监听，每一个站再发生数据之前要检测一下总线上是否有其他计算机在发生数据
MA：多点接入，表示计算机以多点接入的方式连接在一根总线上

- 协议思想：发生帧之前，监听信道

- 监听结果

  - 信道空闲：发送完整帧
  - 信道忙：推迟发送

- 协议

  - 1-坚持CSMA：如果一个主机要发送消息，那么它先监听信道

    空闲则直接输出，不必等待
    忙则一直监听，直到空